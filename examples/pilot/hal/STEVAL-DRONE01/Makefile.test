# Makefile for STEVAL-DRONE01 sensor test program
#
# Standalone test - reads sensors and prints over UART.
# Does NOT require the hive runtime.
#
# Usage:
#   make -f Makefile.test          - Build test firmware
#   make -f Makefile.test flash    - Flash to device
#   make -f Makefile.test clean    - Clean build artifacts
#
# Serial output: 115200 baud on ST-Link virtual COM port

# ------------------------------------------------------------------------------
# Project Configuration
# ------------------------------------------------------------------------------

TARGET = test_sensors
BUILD_DIR = build_test

# ------------------------------------------------------------------------------
# Source Files
# ------------------------------------------------------------------------------

# Test program
SRCS = test_sensors.c

# HAL drivers (no hal_stm32.c or platform wrapper needed)
SRCS += \
	syscalls.c \
	system_config.c \
	gpio_config.c \
	spi1.c \
	i2c1.c \
	tim4.c \
	usart1.c \
	lsm6dsl.c \
	lis2mdl.c \
	lps22hd.c \
	motors.c

# Startup file
ASM_SRCS = startup_stm32f401.s

# ------------------------------------------------------------------------------
# Toolchain
# ------------------------------------------------------------------------------

PREFIX = arm-none-eabi-
CC = $(PREFIX)gcc
AS = $(PREFIX)gcc -x assembler-with-cpp
LD = $(PREFIX)gcc
SZ = $(PREFIX)size
OBJCOPY = $(PREFIX)objcopy

# ------------------------------------------------------------------------------
# MCU Configuration (STM32F401CEU6)
# ------------------------------------------------------------------------------

CPU = -mcpu=cortex-m4
FPU = -mfpu=fpv4-sp-d16
FLOAT-ABI = -mfloat-abi=hard
MCU = $(CPU) -mthumb $(FPU) $(FLOAT-ABI)

# Linker script
LDSCRIPT = stm32f401_flash.ld

# ------------------------------------------------------------------------------
# Compiler Flags
# ------------------------------------------------------------------------------

CFLAGS = -std=c11 -Wall -Wextra
CFLAGS += $(MCU)
CFLAGS += -O2 -g3
CFLAGS += -ffunction-sections -fdata-sections
CFLAGS += -DSTM32F401xE
CFLAGS += -I.
CFLAGS += -MMD -MP

# ------------------------------------------------------------------------------
# Assembler Flags
# ------------------------------------------------------------------------------

ASFLAGS = $(MCU) -g3

# ------------------------------------------------------------------------------
# Linker Flags
# ------------------------------------------------------------------------------

LDFLAGS = $(MCU)
LDFLAGS += -T$(LDSCRIPT)
LDFLAGS += -Wl,--gc-sections
LDFLAGS += -Wl,-Map=$(BUILD_DIR)/$(TARGET).map,--cref
LDFLAGS += --specs=nano.specs
LDFLAGS += -lc -lm -lnosys

# ------------------------------------------------------------------------------
# Build Rules
# ------------------------------------------------------------------------------

OBJS = $(SRCS:%.c=$(BUILD_DIR)/%.o)
ASM_OBJS = $(ASM_SRCS:%.s=$(BUILD_DIR)/%.o)
DEPS = $(OBJS:.o=.d)

all: $(BUILD_DIR)/$(TARGET).elf $(BUILD_DIR)/$(TARGET).bin size

$(BUILD_DIR):
	mkdir -p $@

$(BUILD_DIR)/%.o: %.c | $(BUILD_DIR)
	@echo "CC $<"
	@$(CC) $(CFLAGS) -c $< -o $@

$(BUILD_DIR)/%.o: %.s | $(BUILD_DIR)
	@echo "AS $<"
	@$(AS) $(ASFLAGS) -c $< -o $@

$(BUILD_DIR)/$(TARGET).elf: $(OBJS) $(ASM_OBJS) | $(BUILD_DIR)
	@echo "LD $@"
	@$(LD) $(OBJS) $(ASM_OBJS) $(LDFLAGS) -o $@

$(BUILD_DIR)/$(TARGET).bin: $(BUILD_DIR)/$(TARGET).elf
	@echo "BIN $@"
	@$(OBJCOPY) -O binary $< $@

size: $(BUILD_DIR)/$(TARGET).elf
	@echo ""
	@$(SZ) $<

# ------------------------------------------------------------------------------
# Flash
# ------------------------------------------------------------------------------

flash: $(BUILD_DIR)/$(TARGET).bin
	st-flash write $< 0x8000000

# ------------------------------------------------------------------------------
# Clean
# ------------------------------------------------------------------------------

clean:
	rm -rf $(BUILD_DIR)

-include $(DEPS)

.PHONY: all clean flash size
