#!/bin/bash
# Pre-commit hook for C/H files:
#   1. Auto-format with clang-format
#   2. Check Unicode policy (ASCII only, except box-drawing for diagrams)
#
# Install: git config core.hooksPath scripts
# Or:      ln -sf ../../scripts/pre-commit .git/hooks/pre-commit
#
# To bypass: git commit --no-verify

# Get staged C and H files (excluding deleted files, vendor and lib directories)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d | grep -E '\.(c|h)$' | grep -v -e vendor/ -e lib/)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Check if clang-format is installed
if ! command -v clang-format &> /dev/null; then
    echo "Warning: clang-format not found, skipping format check"
    exit 0
fi

# Auto-format each file and re-stage
for FILE in $STAGED_FILES; do
    clang-format -i "$FILE"
    git add "$FILE"
done

# Check for forbidden Unicode in comments
# Policy: ASCII only in prose, but allow for diagrams:
#   - Box-drawing: U+2500-U+257F (─│┌┐└┘├┤┬┴┼)
#   - Arrows: U+2190-U+2193 (←↑→↓)
UNICODE_VIOLATIONS=""
for FILE in $STAGED_FILES; do
    # Find non-ASCII chars, exclude allowed diagram characters
    if grep -P '[^\x00-\x7F]' "$FILE" | grep -vP '[\x{2500}-\x{257F}\x{2190}-\x{2193}]' > /dev/null 2>&1; then
        UNICODE_VIOLATIONS="$UNICODE_VIOLATIONS $FILE"
    fi
done

if [ -n "$UNICODE_VIOLATIONS" ]; then
    echo "Error: Forbidden Unicode characters in comments (use ASCII):"
    for FILE in $UNICODE_VIOLATIONS; do
        echo "  $FILE:"
        grep -nP '[^\x00-\x7F]' "$FILE" | grep -vP '[\x{2500}-\x{257F}\x{2190}-\x{2193}]' | head -5
    done
    echo ""
    echo "Allowed: Box-drawing (─│┌┐└┘├┤┬┴┼) and arrows (→←↑↓) for diagrams"
    echo "Replace: ^2 for superscripts, deg for degrees, etc."
    echo "Or bypass with: git commit --no-verify"
    exit 1
fi

exit 0
